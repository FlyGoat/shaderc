git:
  depth: 3
env:
  global:
  - AWS_DEFAULT_REGION: us-west-1
  - S3_PARAMS: '"--acl public-read --cache-control \"public,must-revalidate,proxy-revalidate,max-age=0\""'
  - CMAKE_BUILD_PARALLEL_LEVEL: 4
  - LINUX_CMAKE_PARAMS: '"-DSHADERC_ENABLE_SPVC=ON -DSHADERC_SKIP_INSTALL=ON -DSHADERC_SKIP_TESTS=ON
      -DCMAKE_BUILD_TYPE=Release"'
  - secure: Kkf8mEW0LmXM+h2xuVyMBOEGUoHwDbMH6o6NHGcijSm6epOoiJgE48KarFijw/VBl+3kH9gv9n7KIz9viZjGkLdXAfV70b05qq5WMc760gpfVxfEfW/tJ+0jfw0l8cg/mPOgrAVDkwGyIW3NWdCmVQjdr2Lzt0KpQVdCXgmAhZ5tql9DsxgnPhsHnADilAmekhgU/lp06o+PlJ6UqEhcTdH3rPtcOfiSsnzc0i1YZPFkhQ6FPoKKqOyTgdyo5MO9m5U1m5hxqqVfauBfz6R7R/XlC3wmi2+3khm/pavhz6bwgxYZ+z8szHpWPrDys5DwUD/NXQMx/HGQfJqMPP6GxHqrFjNlMnJggN9pb14OynNwf/ZYsKOhCtP+V0dOS57JDzxlz4QlWLijQcbOdRsIaqcgoxo6JjK04hhmCOS2qwhF9UbW+FeVKmFDQQK5JOYGPBMwFIH25JwGBWpbO6dd8pa4Ei6L/wrtmKNC0t/Xd0VUwCcX3aIdB/W2BAa9qXPheGpbuMApiOyyXwhkJEAdgOgQbt/+quovZBHCwbgc8PEluWtlQG8UcS/WgSkwi8T3l04ykeHFWbzUkzP0z3WnBvbPCrysl2/dRyUbHw/FWLOVAY49AsM5GqlVoAnZtHgJCcHfT4wWmjXfte7If4qAfXT/c5BBQ2S7+0AQIA8p2g4=
matrix:
  include:
  - name: Linux x64
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - cmake
        - gcc-4.8
        - g++-4.8
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    script:
    - python3 utils/git-sync-deps
    - mkdir build
    - cd build
    - CC=gcc-4.8 CXX=g++-4.8 cmake $LINUX_CMAKE_PARAMS -DCMAKE_C_FLAGS="-U_FORTIFY_SOURCE
      -D_FORTIFY_SOURCE=0" ..
    - cmake --build .
    - strip libshaderc/libshaderc_shared.so
    - strip libshaderc_spvc/libshaderc_spvc_shared.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > revision.git
    - aws s3 cp libshaderc/libshaderc_shared.so s3://lwjgl-mips64/nightly/linux/x64/libshaderc.so
      $S3_PARAMS
    - aws s3 cp libshaderc_spvc/libshaderc_spvc_shared.so s3://lwjgl-mips64/nightly/linux/x64/libshaderc_spvc.so
      $S3_PARAMS
    - aws s3 cp revision.git s3://lwjgl-mips64/nightly/linux/x64/libshaderc.so.git
      $S3_PARAMS
  - name: Linux arm32
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - cmake
        - gcc-4.8-arm-linux-gnueabihf
        - g++-4.8-arm-linux-gnueabihf
        - libc6-dev-armhf-cross
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    script:
    - python3 utils/git-sync-deps
    - mkdir build
    - cd build
    - CC=arm-linux-gnueabihf-gcc-4.8 CXX=arm-linux-gnueabihf-g++-4.8 cmake $LINUX_CMAKE_PARAMS
      -DCMAKE_C_FLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0" ..
    - cmake --build .
    - arm-linux-gnueabihf-strip libshaderc/libshaderc_shared.so
    - arm-linux-gnueabihf-strip libshaderc_spvc/libshaderc_spvc_shared.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > revision.git
    - aws s3 cp libshaderc/libshaderc_shared.so s3://lwjgl-mips64/nightly/linux/arm32/libshaderc.so
      $S3_PARAMS
    - aws s3 cp libshaderc_spvc/libshaderc_spvc_shared.so s3://lwjgl-mips64/nightly/linux/arm32/libshaderc_spvc.so
      $S3_PARAMS
    - aws s3 cp revision.git s3://lwjgl-mips64/nightly/linux/arm32/libshaderc.so.git
      $S3_PARAMS
  - name: Linux arm64
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - cmake
        - gcc-4.8-aarch64-linux-gnu
        - g++-4.8-aarch64-linux-gnu
        - libc6-dev-arm64-cross
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    script:
    - python3 utils/git-sync-deps
    - mkdir build
    - cd build
    - CC=aarch64-linux-gnu-gcc-4.8 CXX=aarch64-linux-gnu-g++-4.8 cmake $LINUX_CMAKE_PARAMS
      -DCMAKE_C_FLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0" ..
    - cmake --build .
    - aarch64-linux-gnu-strip libshaderc/libshaderc_shared.so
    - aarch64-linux-gnu-strip libshaderc_spvc/libshaderc_spvc_shared.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > revision.git
    - aws s3 cp libshaderc/libshaderc_shared.so s3://lwjgl-mips64/nightly/linux/arm64/libshaderc.so
      $S3_PARAMS
    - aws s3 cp libshaderc_spvc/libshaderc_spvc_shared.so s3://lwjgl-mips64/nightly/linux/arm64/libshaderc_spvc.so
      $S3_PARAMS
    - aws s3 cp revision.git s3://lwjgl-mips64/nightly/linux/arm64/libshaderc.so.git
      $S3_PARAMS
  - name: Linux mips64
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - cmake
        - gcc-5-mips64el-linux-gnuabi64
        - g++-5-mips64el-linux-gnuabi64
        - libc6-dev-mips64el-cross
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    script:
    - python3 utils/git-sync-deps
    - mkdir build
    - cd build
    - CC=mips64el-linux-gnuabi64-gcc-5 CXX=mips64el-linux-gnuabi64-g++-5 cmake $LINUX_CMAKE_PARAMS
      -DCMAKE_C_FLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0" ..
    - cmake --build .
    - mips64el-linux-gnuabi64-strip libshaderc/libshaderc_shared.so
    - mips64el-linux-gnuabi64-strip libshaderc_spvc/libshaderc_spvc_shared.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > revision.git
    - aws s3 cp libshaderc/libshaderc_shared.so s3://lwjgl-mips64/nightly/linux/mips64/libshaderc.so
      $S3_PARAMS
    - aws s3 cp libshaderc_spvc/libshaderc_spvc_shared.so s3://lwjgl-mips64/nightly/linux/mips64/libshaderc_spvc.so
      $S3_PARAMS
    - aws s3 cp revision.git s3://lwjgl-mips64/nightly/linux/mips64/libshaderc.so.git
      $S3_PARAMS
  - name: macOS
    language: objective-c
    osx_image: xcode11.3
    compiler: clang
    before_install:
    - brew update
    install:
    - brew install awscli
    script:
    - python3 utils/git-sync-deps
    - mkdir build
    - cd build
    - cmake $LINUX_CMAKE_PARAMS -DCMAKE_OSX_DEPLOYMENT_TARGET=10.9 ..
    - cmake --build .
    - strip -u -r libshaderc/libshaderc_shared.dylib
    - strip -u -r libshaderc_spvc/libshaderc_spvc_shared.dylib
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > revision.git
    - aws s3 cp libshaderc/libshaderc_shared.dylib s3://lwjgl-mips64/nightly/macosx/x64/libshaderc.dylib
      $S3_PARAMS
    - aws s3 cp libshaderc_spvc/libshaderc_spvc_shared.dylib s3://lwjgl-mips64/nightly/macosx/x64/libshaderc_spvc.dylib
      $S3_PARAMS
    - aws s3 cp revision.git s3://lwjgl-mips64/nightly/macosx/x64/libshaderc.dylib.git
      $S3_PARAMS
